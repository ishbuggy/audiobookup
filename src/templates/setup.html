<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>AudioBookup - Setup</title>
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_16.png') }}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_32.png') }}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="96x96"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_96.png') }}"
        />
        <link
            rel="apple-touch-icon"
            sizes="144x144"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_144.png') }}"
        />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    </head>
    <body class="page-centered-container">
        <button
            id="theme-toggle-btn"
            class="top-right-icon-btn"
            style="position: absolute; right: 1em; top: 1em"
            title="Toggle Theme"
        >
            <i class="fas fa-moon"></i>
        </button>
        <div class="form-card">
            <!-- Step 1: Configuration Form (Visible by default) -->
            <div id="setup-step-1">
                <div class="header-title" style="justify-content: center; margin-bottom: 1em">
                    <img
                        src="{{ url_for('static', filename='img/AudioBookup_Icon.png') }}"
                        alt="AudioBookup Logo"
                        class="header-logo"
                    />
                    <h1>AudioBookup</h1>
                </div>
                <h2><i class="fas fa-key"></i> Connect to Audible</h2>

                <p style="text-align: center; color: #555; margin-bottom: 1.5em">
                    First, select your Audible marketplace and configure a few options.
                </p>

                <div class="form-group">
                    <label for="country-select">Audible Marketplace:</label>
                    <select id="country-select" name="country_code">
                        <option value="us">United States</option>
                        <option value="uk">United Kingdom</option>
                        <option value="ca">Canada</option>
                        <option value="de">Germany</option>
                        <option value="fr">France</option>
                        <option value="au">Australia</option>
                        <option value="jp">Japan</option>
                        <option value="in">India</option>
                        <option value="it">Italy</option>
                        <option value="es">Spain</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="advanced-options-toggle">Show Advanced Options</label>
                    <label class="switch">
                        <input type="checkbox" id="advanced-options-toggle" />
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="advanced-options-panel" class="advanced-setup-panel" style="display: none">
                    <div class="form-group">
                        <label for="profile-name">Profile Name:<small>Internal name for this connection.</small></label>
                        <input type="text" id="profile-name" name="profile_name" />
                    </div>
                    <div class="form-group">
                        <label for="auth-file-name"
                            >Auth File Name:<small>The file that stores login tokens.</small></label
                        >
                        <input type="text" id="auth-file-name" name="auth_file" />
                    </div>
                    <div class="form-group">
                        <label for="legacy-account-toggle"
                            >Legacy Account:<small>This is a pre-Amazon Audible account.</small></label
                        >
                        <label class="switch">
                            <input type="checkbox" id="legacy-account-toggle" name="with_username" />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="encrypt-file-toggle">Encrypt Authentication File</label>
                    <label class="switch">
                        <input type="checkbox" id="encrypt-file-toggle" />
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="password-panel" class="advanced-setup-panel" style="display: none">
                    <div class="form-group stacked">
                        <label for="auth-file-password">Password:</label>
                        <input type="password" id="auth-file-password" name="auth_file_password" class="w-100" />
                    </div>
                    <div class="form-group stacked">
                        <label for="auth-file-password-confirm">Confirm Password:</label>
                        <input type="password" id="auth-file-password-confirm" class="w-100" />
                    </div>
                </div>

                <button id="start-setup-btn" class="action-button blue w-100" style="margin-top: 2em">
                    Start Connection
                </button>
            </div>

            <!-- Step 2: Authentication Step (Hidden by default) -->
            <div id="setup-step-2" style="display: none; text-align: center">
                <div class="header-title" style="justify-content: center; margin-bottom: 1em">
                    <img
                        src="{{ url_for('static', filename='img/AudioBookup_Icon.png') }}"
                        alt="AudioBookup Logo"
                        class="header-logo"
                    />
                    <h1>AudioBookup</h1>
                </div>
                <h2><i class="fab fa-audible"></i> Log in to Audible</h2>
                <div class="info-box">
                    <p>
                        Click the button below to open the Audible login page in a new tab. After you log in, you will
                        be redirected to a page that may look like an error. The page will probably look like the image
                        below:
                    </p>
                    <img
                        src="{{ url_for('static', filename='img/setup-redirect-example.png') }}"
                        alt="Screenshot of the expected Amazon redirect error page"
                        style="
                            max-width: 100%;
                            border-radius: 5px;
                            border: 1px solid var(--color-border);
                            margin-top: 1em;
                        "
                    />
                    <p style="margin-top: 1em">
                        <strong>This is expected.</strong> Copy the entire URL from that page's address bar.
                    </p>
                </div>
                <button id="open-audible-btn" class="action-button green w-100" disabled>
                    <i class="fas fa-spinner fa-spin"></i> Waiting for URL from server...
                </button>
                <div class="form-group stacked" style="margin-top: 1.5em">
                    <label for="paste-url">Paste the copied URL here:</label>
                    <input type="text" id="paste-url" class="w-100" />
                </div>
                <button id="submit-url-btn" class="action-button blue w-100" style="margin-top: 1em">Submit URL</button>
            </div>

            <!-- Step 3: Performance Optimization (Hidden by default) -->
            <div id="setup-step-3" style="display: none; text-align: center">
                <div class="header-title" style="justify-content: center; margin-bottom: 1em">
                    <img
                        src="{{ url_for('static', filename='img/AudioBookup_Icon.png') }}"
                        alt="AudioBookup Logo"
                        class="header-logo"
                    />
                    <h1>AudioBookup</h1>
                </div>
                <h2><i class="fas fa-rocket"></i> Performance Optimization</h2>
                <p style="color: var(--color-text-muted)">
                    For the fastest audiobook conversions, set the number of processing cores.
                </p>

                <div class="form-group" style="padding: 2em 0; text-align: left">
                    <label for="setup-total-cores-input">
                        Total Processing Cores
                        <small style="display: block; font-weight: normal">
                            A good default is your system's total CPU cores minus one.
                        </small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5em">
                        <input type="number" id="setup-total-cores-input" value="2" min="1" max="16" />
                        <button
                            id="setup-auto-concurrency-btn"
                            class="action-button"
                            title="Auto-detect based on system hardware"
                        >
                            <i class="fas fa-magic"></i> Auto-detect
                        </button>
                    </div>
                </div>

                <p style="font-size: 0.9em; color: var(--color-text-muted); margin-top: 1em">
                    This setting, along with advanced options, can be changed later on the main
                    <strong>Settings</strong> page.
                </p>

                <button id="setup-save-settings-btn" class="action-button green w-100" style="margin-top: 1em">
                    Save and Continue to Dashboard
                </button>
            </div>
        </div>
        <div id="custom-alert-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 400px; text-align: center">
                <div class="modal-header">
                    <h2 id="custom-alert-title" style="width: 100%; text-align: center"></h2>
                </div>
                <div class="modal-body">
                    <p id="custom-alert-message" style="font-size: 1.1em"></p>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button id="custom-alert-ok-btn" class="action-button blue">OK</button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- Element References ---
                const step1 = document.getElementById("setup-step-1");
                const step2 = document.getElementById("setup-step-2");
                const step3 = document.getElementById("setup-step-3");

                // Step 1 Elements
                const countrySelect = document.getElementById("country-select");
                const advancedToggle = document.getElementById("advanced-options-toggle");
                const advancedPanel = document.getElementById("advanced-options-panel");
                const profileNameInput = document.getElementById("profile-name");
                const authFileNameInput = document.getElementById("auth-file-name");
                const encryptToggle = document.getElementById("encrypt-file-toggle");
                const passwordPanel = document.getElementById("password-panel");
                const passwordInput = document.getElementById("auth-file-password");
                const passwordConfirmInput = document.getElementById("auth-file-password-confirm");
                const startSetupBtn = document.getElementById("start-setup-btn");

                // Step 2 Elements
                const openAudibleBtn = document.getElementById("open-audible-btn");
                const pasteUrlInput = document.getElementById("paste-url");
                const submitUrlBtn = document.getElementById("submit-url-btn");

                // --- Initial State & Event Listeners ---

                // Auto-generate default names when country changes
                countrySelect.addEventListener("change", () => {
                    if (!advancedToggle.checked) {
                        const country = countrySelect.value;
                        profileNameInput.value = `profile_${country}`;
                        authFileNameInput.value = `auth_${country}`;
                    }
                });
                // Trigger change event to populate initial values
                countrySelect.dispatchEvent(new Event("change"));

                // Show/hide advanced panel
                advancedToggle.addEventListener("change", () => {
                    advancedPanel.style.display = advancedToggle.checked ? "block" : "none";
                });

                // Show/hide password panel
                encryptToggle.addEventListener("change", () => {
                    passwordPanel.style.display = encryptToggle.checked ? "block" : "none";
                });

                // --- Socket.IO Connection ---
                const socket = io({ path: "/setup/socket.io" });

                socket.on("connect", () => {
                    console.log("Socket.IO connection established for setup.");
                });

                socket.on("disconnect", () => {
                    console.log("Socket.IO disconnected.");
                });

                // Listen for the URL from the backend
                socket.on("audible_login_url_ready", (data) => {
                    openAudibleBtn.onclick = () => window.open(data.url, "_blank");
                    openAudibleBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> Open Audible Login Page';
                    openAudibleBtn.disabled = false;
                });

                // Listen for the final output from the PTY process
                socket.on("pty_output", (data) => {
                    // Check for success or failure keywords in the final output
                    if (data.output.includes("SUCCESS! Authentication is valid")) {
                        step2.style.display = "none";
                        step3.innerHTML = `
                            <h1 style="color: #155724;"><i class="fas fa-check-circle"></i> Success!</h1>
                            <p>Authentication complete. You will be redirected to the dashboard automatically.</p>
                        `;
                        step3.style.display = "block";
                        setTimeout(() => (window.location.href = "/"), 3000);
                    } else if (data.output.includes("FAILED")) {
                        step2.style.display = "none";
                        step3.innerHTML = `
                            <h1 style="color: #721c24;"><i class="fas fa-times-circle"></i> Failed</h1>
                            <p>Authentication failed. Please restart the container and try again.</p>
                            <pre style="background: #f8d7da; padding: 1em; border-radius: 5px; text-align: left; white-space: pre-wrap;">${data.output}</pre>
                        `;
                        step3.style.display = "block";
                    }
                });

                // --- Button Click Handlers ---

                // START SETUP button
                startSetupBtn.addEventListener("click", () => {
                    // Validate password confirmation if encryption is enabled
                    if (encryptToggle.checked) {
                        if (passwordInput.value.length === 0) {
                            alert("Password cannot be empty when encryption is enabled.");
                            return;
                        }
                        if (passwordInput.value !== passwordConfirmInput.value) {
                            alert("Passwords do not match.");
                            return;
                        }
                    }

                    // Collect all form data
                    const setupData = {
                        profile_name: profileNameInput.value,
                        auth_file: authFileNameInput.value,
                        country_code: countrySelect.value,
                        with_username: document.getElementById("legacy-account-toggle").checked,
                        encrypt: encryptToggle.checked,
                        auth_file_password: encryptToggle.checked ? passwordInput.value : null,
                    };

                    // Send data to backend to start the process
                    socket.emit("start_audible_setup", setupData);

                    // Transition UI to the next step
                    step1.style.display = "none";
                    step2.style.display = "block";
                });

                // SUBMIT URL button
                submitUrlBtn.addEventListener("click", () => {
                    const url = pasteUrlInput.value;
                    if (url) {
                        // Add a newline to simulate pressing Enter in the terminal
                        socket.emit("pty_input", { input: url + "\\n" });
                        submitUrlBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                        submitUrlBtn.disabled = true;
                        pasteUrlInput.disabled = true;
                    }
                });
            });
        </script>
        <script src="{{ url_for('static', filename='js/common.js') }}"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const step2Div = document.getElementById("setup-step-2");
                const step3Div = document.getElementById("setup-step-3");
                const saveBtn = document.getElementById("setup-save-settings-btn");
                const socket = io({ path: "/setup/socket.io" });

                // 1. Setup the auto-detect functionality and get a reference to the handler
                const triggerAutoDetect = setupAutoConcurrencyDetector(
                    "setup-auto-concurrency-btn",
                    "setup-total-cores-input",
                );

                // 2. Listen for the success event from the backend
                socket.on("audible_setup_successful", () => {
                    step2Div.style.display = "none";
                    step3Div.style.display = "block";
                    // 3. The user can trigger the autodetect, or continue with the default number of threads
                });

                // 4. Setup the save button (this logic is unique to this page)
                const handleSaveAndContinue = async () => {
                    const coresInput = document.getElementById("setup-total-cores-input");
                    const cores = parseInt(coresInput.value, 10);
                    if (!cores || cores < 1) {
                        alert("Please enter a valid number of cores (at least 1).");
                        return;
                    }
                    saveBtn.classList.add("is-processing");
                    saveBtn.disabled = true;
                    const settingsToSave = { job: { download: { total_processing_cores: cores } } };
                    try {
                        const response = await fetch("/api/settings", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(settingsToSave),
                        });
                        if (!response.ok) throw new Error("Failed to save settings.");
                        window.location.href = "/";
                    } catch (error) {
                        alert(`Error: ${error.message}. Redirecting, but please verify in settings.`);
                        setTimeout(() => {
                            window.location.href = "/";
                        }, 2000);
                    }
                };
                saveBtn.addEventListener("click", handleSaveAndContinue);
            });
        </script>
        <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    </body>
</html>

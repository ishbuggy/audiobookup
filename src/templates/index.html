<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>AudioBookup</title>
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_16.png') }}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_32.png') }}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="96x96"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_96.png') }}"
        />
        <link
            rel="apple-touch-icon"
            sizes="144x144"
            href="{{ url_for('static', filename='img/AudioBookup_Favicon_144.png') }}"
        />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    </head>
    <body>
        <div class="container">
            <div id="auth-warning-banner" style="display: none">
                <i class="fas fa-shield-alt"></i>
                <div class="auth-warning-text">
                    <strong>Authentication Issue:</strong>
                    <span id="auth-warning-message"></span>
                </div>
                <button id="re-auth-btn">Re-authenticate</button>
            </div>

            <!-- START: Header with Logo -->
            <div class="dashboard-header">
                <div class="header-title">
                    <img
                        src="{{ url_for('static', filename='img/AudioBookup_Icon.png') }}"
                        alt="AudioBookup Logo"
                        class="header-logo"
                    />
                    <h1>AudioBookup</h1>
                </div>
                <div class="header-actions">
                    <button id="theme-toggle-btn" class="top-right-icon-btn" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <a href="{{ url_for('logout') }}" id="logout-icon-btn" class="top-right-icon-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                    <a
                        href="{{ url_for('history') }}"
                        id="history-icon-btn"
                        class="top-right-icon-btn"
                        title="Job History"
                    >
                        <i class="fas fa-history"></i>
                    </a>
                    <a href="{{ url_for('settings') }}" id="settings-btn" class="top-right-icon-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </a>
                </div>
            </div>
            <!-- END: Header with Logo -->

            <!-- START: Two-Column Dashboard Layout -->
            <div class="dashboard-grid">
                <!-- Left "Main" Column -->
                <div class="dashboard-main">
                    <div class="actions">
                        <button class="action-button blue" data-script="sync">Sync Library</button>
                        <button class="action-button blue" data-script="download">Process Downloads</button>
                    </div>

                    <!-- Automation Banner -->
                    <div
                        id="automation-status-banner"
                        style="
                            display: none;
                            background-color: #cce5ff;
                            color: #004085;
                            border: 1px solid #b8daff;
                            border-radius: 8px;
                            padding: 1em;
                            margin-bottom: 2em;
                            cursor: pointer;
                        "
                        title="Click to configure automation settings"
                    >
                        <div style="display: flex; align-items: center; gap: 1em">
                            <i class="fas fa-robot" style="font-size: 1.5em"></i>
                            <div id="automation-status-text"></div>
                        </div>
                    </div>

                    <!-- Job Status Panel (in Left Column) -->
                    <div id="processing-panel">
                        <div class="panel-header">
                            <h3 id="processing-panel-title">Job Status</h3>
                            <button id="cancel-job-btn" style="display: none">Cancel Job</button>
                            <button id="clear-report-btn" style="display: none">Clear Finished</button>
                            <span class="panel-chevron"><i class="fas fa-chevron-up"></i></span>
                        </div>
                        <div id="processing-list"></div>
                    </div>
                </div>

                <!-- Right "Sidebar" Column -->
                <div class="dashboard-sidebar">
                    <h2>Library Status</h2>
                    <div class="status-grid" id="status-grid">
                        <div class="status-box downloaded">
                            <div class="status-header">
                                <i class="fas fa-check-circle"></i>
                                <h3>Downloaded</h3>
                            </div>
                            <p id="stats-downloaded">{{ stats.DOWNLOADED or 0 }}</p>
                        </div>
                        <div class="status-box new">
                            <div class="status-header">
                                <i class="fas fa-star"></i>
                                <h3>New</h3>
                            </div>
                            <p id="stats-new">{{ stats.NEW or 0 }}</p>
                        </div>
                        <div class="status-box missing">
                            <div class="status-header">
                                <i class="fas fa-question-circle"></i>
                                <h3>Missing</h3>
                            </div>
                            <p id="stats-missing">{{ stats.MISSING or 0 }}</p>
                        </div>
                        <div class="status-box error">
                            <div class="status-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>Error</h3>
                            </div>
                            <p id="stats-error">{{ stats.ERROR or 0 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END: Two-Column Dashboard Layout -->

        <div id="library-container">
            <h2>Full Library</h2>
            <div id="library-controls">
                <input type="search" id="search-bar" placeholder="Search by title, author, narrator..." />
                <select id="filter-by-status">
                    <option value="">All Statuses</option>
                    <option value="DOWNLOADED">Downloaded</option>
                    <option value="NEW">New</option>
                    <option value="MISSING">Missing</option>
                    <option value="ERROR">Error</option>
                </select>
                <select id="sort-by">
                    <option value="author_asc">Author (A-Z)</option>
                    <option value="author_desc">Author (Z-A)</option>
                    <option value="title_asc">Title (A-Z)</option>
                    <option value="title_desc">Title (Z-A)</option>
                    <option value="release_date_desc">Release Date (Newest)</option>
                    <option value="release_date_asc">Release Date (Oldest)</option>
                    <option value="date_added_desc">Date Added (Newest)</option>
                    <option value="date_added_asc">Date Added (Oldest)</option>
                </select>
            </div>
            <div id="library-grid">
                {% for book in books %}
                <div class="book-card" data-asin="{{ book.asin }}">
                    <img
                        class="book-card-cover lazy-load"
                        src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                        data-src="{{ book.cover_url }}"
                        alt="Cover for {{ book.title }}"
                    />
                    <div class="book-card-info">
                        <p class="book-card-title">{{ book.title }}</p>
                        <p class="book-card-author">{{ book.author }}</p>
                        <span class="book-card-status status-{{ book.status }}">{{ book.status }}</span>
                        <div class="book-card-actions">
                            {% if book.status == 'ERROR' or book.status == 'MISSING' %}
                            <button class="retry-button" data-asin="{{ book.asin }}">Retry</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <p>No books found in the database. Run a sync to populate your library.</p>
                {% endfor %}
            </div>
        </div>

        <div id="log-container">
            <div class="log-header">
                <div id="status-line-wrapper">
                    <span class="status-indicator"></span>
                    <span>Server Online</span>
                    <span>{{ server_version }}</span>
                    <span style="color: var(--color-text-muted)">|</span>
                    <span class="status-label">Status:</span>
                    <p id="latest-log-line"></p>
                </div>
                <div class="log-actions">
                    <button id="toggle-log-btn" title="Toggle Log View"><i class="fas fa-chevron-up"></i></button>
                    <form id="clear-log-form" action="/clear_log" method="post" style="margin: 0">
                        <button type="submit" title="Clear Log">Clear</button>
                    </form>
                </div>
            </div>
            <pre id="log-output">{{ log_history }}</pre>
        </div>
        <!-- START: CONFIRMATION MODAL -->
        <div id="confirmation-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px; text-align: center">
                <div class="modal-header">
                    <h2 id="confirmation-title" style="width: 100%; text-align: center">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545"></i> Are you sure?
                    </h2>
                </div>
                <div class="modal-body">
                    <p id="confirmation-message" style="font-size: 1.1em"></p>
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 1em">
                    <button id="confirmation-cancel-btn" class="action-button">Cancel</button>
                    <button id="confirmation-confirm-btn" class="action-button blue">Confirm</button>
                </div>
            </div>
        </div>
        <!-- END: CONFIRMATION MODAL -->

        <div id="book-detail-modal" class="modal-overlay">
            <div class="modal-content modal-large">
                <span class="close-btn" id="detail-modal-close">&times;</span>

                <!-- START: Two-Part Modal Structure -->

                <!-- Part 1: Top section with two columns (Cover + Key Details) -->
                <div class="modal-top-section">
                    <div class="modal-cover">
                        <img id="modal-book-cover" src="" alt="Book Cover" />
                    </div>
                    <div class="modal-details-column">
                        <h2 id="modal-book-title">Book Title</h2>
                        <p><strong>Author:</strong> <span id="modal-book-author"></span></p>
                        <p><strong>Narrator:</strong> <span id="modal-book-narrator"></span></p>
                        <p><strong>Series:</strong> <span id="modal-book-series"></span></p>
                        <p><strong>Publisher:</strong> <span id="modal-book-publisher"></span></p>
                        <p><strong>Runtime:</strong> <span id="modal-book-runtime"></span> minutes</p>
                        <p><strong>Release Date:</strong> <span id="modal-book-release-date"></span></p>
                        <p><strong>Date Added:</strong> <span id="modal-book-date-added"></span></p>
                        <p><strong>Language:</strong> <span id="modal-book-language"></span></p>
                        <p><strong>ASIN:</strong> <span id="modal-book-asin"></span></p>
                        <p><strong>Status:</strong> <span id="modal-book-status"></span></p>
                    </div>
                </div>

                <!-- Part 2: Bottom, full-width, scrollable section -->
                <div class="modal-bottom-section">
                    <div id="modal-summary-container" style="margin-top: 1em">
                        <h4>Summary</h4>
                        <p id="modal-book-summary" style="font-size: 0.9em; white-space: pre-wrap"></p>
                        <button id="fetch-full-summary-btn" style="display: none; margin-top: 0.5em">
                            <i class="fas fa-book-open"></i> Get Full Summary
                        </button>
                    </div>

                    <h4 style="margin-top: 1em">File Information</h4>
                    <p><strong>Path:</strong> <span id="modal-file-path"></span></p>
                    <p><strong>Type:</strong> <span id="modal-file-type"></span></p>
                    <p><strong>Size:</strong> <span id="modal-file-size"></span></p>
                    <p><strong>Last Modified:</strong> <span id="modal-file-mtime"></span></p>

                    <div id="modal-error-details" style="display: none; margin-top: 1em">
                        <h4 style="color: #721c24">Error Information</h4>
                        <pre
                            id="modal-book-error"
                            style="
                                background-color: #f8d7da;
                                color: #721c24;
                                padding: 1em;
                                border-radius: 5px;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                                font-size: 0.9em;
                            "
                        ></pre>
                    </div>
                </div>

                <!-- END: Two-Part Modal Structure -->
            </div>
        </div>

        <div id="download-selection-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px">
                <div class="modal-header">
                    <h2>Select Books to Process</h2>
                    <span class="close-btn" id="selection-modal-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="selection-actions" style="margin-bottom: 1em; display: flex; gap: 1em">
                        <button id="select-all-btn" class="action-button">Select All</button>
                        <button id="select-none-btn" class="action-button">Select None</button>
                    </div>
                    <div
                        id="selection-book-list"
                        style="
                            max-height: 40vh;
                            overflow-y: auto;
                            border: 1px solid #dee2e6;
                            padding: 1em;
                            border-radius: 5px;
                        "
                    ></div>
                </div>
                <div class="modal-footer">
                    <button id="process-selected-btn" style="background-color: #28a745">
                        Process Selected (<span id="selection-count">0</span>)
                    </button>
                </div>
            </div>
        </div>

        <div id="custom-alert-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 400px; text-align: center">
                <div class="modal-header">
                    <h2 id="custom-alert-title" style="width: 100%; text-align: center">
                        <i class="fas fa-exclamation-triangle" style="color: #ffc107"></i> Warning
                    </h2>
                </div>
                <div class="modal-body">
                    <p id="custom-alert-message" style="font-size: 1.1em"></p>
                </div>
                <div class="modal-footer" style="justify-content: center">
                    <button id="custom-alert-ok-btn" class="action-button blue">OK</button>
                </div>
            </div>
        </div>

        <input type="file" id="import-file-input" style="display: none" accept=".json" />
        <!-- Load shared helper functions first -->
        <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
        <!-- Load the page-specific logic for the index page -->
        <script src="{{ url_for('static', filename='js/index.js') }}"></script>
        <!-- Load the theme switcher last -->
        <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    </body>
</html>
